Run once per project:
gcloud compute firewall-rules create mosh --allow udp:60001-60010

Run once per workstation:
gcloud config set compute/zone us-central1-b
gcloud config set project speech-danstutzman
---------------------

gcloud compute instances create speech \
  --image ubuntu-15-10 \
  --machine-type n1-standard-1

gcloud compute ssh speech 'sudo shutdown +2400 -P'

gcloud compute ssh speech 'sudo apt-get install -y mosh'

gcloud compute copy-files ~/dev/htk/HTK-3.4.1.tar.gz speech:HTK-3.4.1.tar.gz

gcloud compute ssh speech <<EOF
set -ex
sudo mkdir -p /usr/local/bin.linux
sudo chown daniel:daniel /usr/local/bin.linux
sudo apt-get install -y build-essential libc6-dev-i386 libx11-dev ruby
tar xvzf HTK-3.4.1.tar.gz
cd htk
rm configure.ac
CFLAGS="-L/usr/lib/x86_64-linux-gnu -m64" ./configure --enable-trad-htk
ruby -i -pe 'gsub /^        if/, "\tif"' HLMTools/Makefile
make all
EOF

gcloud compute ssh speech <<EOF
set -ex
wget http://www.openslr.org/resources/1/waves_yesno.tar.gz
tar -xvzf waves_yesno.tar.gz

tee make_words_mlf.rb <<EOF2
puts '#!MLF!#'
Dir.glob('/home/daniel/waves_yesno/*.wav') do |path|
  filename = path.split('/').last
  puts "\"*/#{filename}\""
  filename.gsub(/\.wav/, '').split('_').each do |part|
    puts ({'0' => 'NO', '1' => 'YES'})[part]
  end
  puts '.'
end
EOF2
ruby make_words_mlf.rb > words.mlf

tee gram <<EOF2
$yn = YES | NO;
( SENT-START $yn $yn $yn $yn $yn $yn $yn $yn SENT-END )
EOF2
htk/HTKTools/HParse gram wdnet
tee dict <<EOF2
SENT-START [] sil
SENT-END [] sil
YES y
NO n
EOF2

tee config <<EOF2
SOURCEFORMAT = WAV
# Coding parameters
TARGETKIND = MFCC_0
TARGETRATE = 100000.0
SAVECOMPRESSED = T
SAVEWITHCRC = T
WINDOWSIZE = 250000.0
USEHAMMING = T
PREEMCOEF = 0.97
NUMCHANS = 26
CEPLIFTER = 22
NUMCEPS = 12
ENORMALISE = F
EOF2

rm -f coretr.scp
for WAV in /home/daniel/waves_yesno/*.wav; do
  MFC=`echo $WAV | sed 's/wav$/mfc/'`
  echo "$WAV $MFC" >> coretr.scp
done
htk/HTKTools/HCopy -T 1 -C config -S coretr.scp
EOF
